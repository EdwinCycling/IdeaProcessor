rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {
    
    // User specific data (Settings, Saved Sessions)
    match /users/{userId}/{document=**} {
      allow read, write: if request.auth != null && request.auth.uid == userId;
    }

    // Session Codes:
    // - Read: Public (to lookup session)
    // - Write: Authenticated users (to claim a code)
    match /session_codes/{code} {
      allow read: if true;
      allow write: if request.auth != null;
    }

    // Session document:
    // - Read: Public
    // - Write: Owner only
    match /sessions/{sessionId} {
      allow read: if true;
      allow list: if true;
      // Allow write if user is owner (sessionId is their UID) OR if it's the legacy global session (for backward compat if needed by admin)
      allow write: if request.auth != null && (request.auth.uid == sessionId || sessionId == 'idea-live-event');

      // Ideas collection within a session:
      // - Read: Owner only
      // - Create: Public (but with validation)
      // - Update/Delete: Owner only
      match /ideas/{ideaId} {
        allow read: if request.auth != null && (request.auth.uid == sessionId || sessionId == 'idea-live-event');
        allow create: if 
          // Session must be active
          get(/databases/$(database)/documents/sessions/$(sessionId)).data.isActive == true &&
          // Must have required fields
          request.resource.data.keys().hasAll(['name', 'content', 'timestamp']) &&
          // Name must be string and max 50 chars
          request.resource.data.name is string &&
          request.resource.data.name.size() <= 50 &&
          // Content must be string and max 500 chars
          request.resource.data.content is string &&
          request.resource.data.content.size() <= 500 &&
          // Timestamp must be a number
          request.resource.data.timestamp is number;
        
        allow update, delete: if request.auth != null && (request.auth.uid == sessionId || sessionId == 'idea-live-event');
      }

      // Reports collection (PDFs):
      // - Read/Write: Owner only
      match /reports/{reportId} {
        allow read, write: if request.auth != null && (request.auth.uid == sessionId || sessionId == 'idea-live-event');
      }
    }
  }
}